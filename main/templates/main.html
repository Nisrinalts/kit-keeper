{% extends 'base.html' %}
{% load static %}
{% block title %}Product List — KitKeeper{% endblock title %}

{% block meta %}
<script>
  tailwind.config = {
    theme: {
      extend: {
        backgroundImage: {
          'kk-pink':  'radial-gradient(circle, #F2D7D4, #EBC3C1, #E3ADA7)',
          'kk-rose':  'radial-gradient(circle, #EED9DC, #D2A3A9, #C28F95)',
          'kk-amber': 'radial-gradient(circle, #C98F70, #AF6E4E, #8F5336)',
        },
      }
    }
  }
</script>
<link rel="stylesheet" href="{% static 'css/global.css' %}">
<style>
  body { background: radial-gradient(circle, #F2D7D4, #EBC3C1, #E3ADA7); }
</style>
{% endblock meta %}

{% block content %}
<!-- HERO -->
<div class="mb-6">
  <div class="rounded-2xl overflow-hidden border border-white/60 shadow-[0_12px_32px_rgba(0,0,0,.12)]">
    <div class="relative h-52 sm:h-64 md:h-80 bg-welcome">
      <div class="absolute inset-0 bg-gradient-to-t from-black/25 via-black/5 to-transparent"></div>
      <div class="absolute left-5 sm:left-7 bottom-5 sm:bottom-7">
        <h1 class="text-white tracking-tight drop-shadow-[0_3px_10px_rgba(0,0,0,.35)]
                   text-2xl sm:text-3xl md:text-4xl lg:text-5xl font-medium">
          <span>Welcome,&nbsp;</span>
          <span class="font-extrabold">
            {{ request.user.first_name|default:request.user.username|default:"Guest" }}
          </span>
        </h1>
      </div>
    </div>
  </div>
</div>

<!-- WRAPPER -->
<div class="min-h-[calc(100dvh-4rem)] px-3 sm:px-4 py-4">
  <div class="max-w-screen-xl mx-auto rounded-[18px] p-4 sm:p-6
              bg-[radial-gradient(circle,_#EED9DC,_#D2A3A9,_#C28F95)]
              border border-black/10 shadow-[0_14px_32px_rgba(0,0,0,0.14)]">

    <!-- HEADER ACTIONS -->
    <header class="grid gap-2 sm:gap-3 md:grid-cols-[1fr_auto] items-start mb-4">
      <div>
        <div class="flex items-center gap-2 flex-wrap">
          <a id="filter-all" href="{% url 'main:show_main' %}?tab=all"
             class="px-3 py-2 rounded-[12px] border text-sm sm:text-[0.95rem] transition
                    {% if active_tab == 'all' %}
                      bg-[#fff7cc] border-[#f5df95] text-[#111827] font-semibold
                    {% else %}
                      bg-white border-[#e5e7eb] text-[#111827]
                      hover:bg-[#ffb6c1] hover:text-white hover:border-[#ffb6c1]
                    {% endif %}">
            All Products
          </a>

          <a id="filter-my" href="{% url 'main:show_main' %}?tab=mine"
             class="px-3 py-2 rounded-[12px] border text-sm sm:text-[0.95rem] transition
                    {% if active_tab == 'mine' %}
                      bg-[#fff7cc] border-[#f5df95] text-[#111827] font-semibold
                    {% else %}
                      bg-white border-[#e5e7eb] text-[#111827]
                      hover:bg-[#ffb6c1] hover:text-white hover:border-[#ffb6c1]
                    {% endif %}">
            My Products
          </a>

          <!-- Create -->
          <button type="button" onclick="openCreateModal()"
                  class="px-3 py-2 rounded-[12px] border text-sm sm:text-[0.95rem] transition
                         bg-white border-[#e5e7eb] text-[#111827]
                         hover:bg-[#ffb6c1] hover:text-white hover:border-[#ffb6c1]">
            Add Product (AJAX)
          </button>

          <!-- Refresh UX -->
          <button id="btn-refresh" type="button"
                  class="px-3 py-2 rounded-[12px] border text-sm sm:text-[0.95rem] transition
                         bg-white border-[#e5e7eb] text-[#111827] flex items-center gap-2
                         hover:bg-[#ffb6c1] hover:text-white hover:border-[#ffb6c1]">
            <svg id="rf-icon" class="h-4 w-4 hidden" viewBox="0 0 24 24" fill="none" stroke="currentColor">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                    d="M4 4v6h6M20 20v-6h-6M5 19a9 9 0 0014-7 9 9 0 00-9-9" />
            </svg>
            <span>Refresh</span>
          </button>
        </div>
      </div>

      <div class="text-xs sm:text-[0.95rem] text-[#FFFFFF] md:text-right">
        Last login: {{ last_login }}
      </div>
    </header>

    <!-- SERVER PLACEHOLDER -->
    <div id="kk-server-list">
      {% if products %}
        <div class="grid gap-5 sm:grid-cols-2 lg:grid-cols-3 justify-items-center">
          {% for p in products %}
            {% include 'card_product.html' with product=p counter=forloop.counter cardbg='bg-[#E6DCE5]' %}
          {% endfor %}
        </div>
      {% else %}
        <div class="flex flex-col items-center justify-center py-12 sm:py-16 text-center">
          <img src="{% static 'img/empty-products.png' %}" alt="No products"
               class="w-28 h-28 sm:w-36 sm:h-36 object-cover rounded-xl shadow-md" />
          {% if active_tab == 'mine' %}
            <h3 class="mt-4 text-lg sm:text-xl font-semibold text-[#111827]">No products in your collection</h3>
            <p class="text-[#6b7280] text-sm sm:text-base">Start by adding your first product.</p>
          {% else %}
            <h3 class="mt-4 text-lg sm:text-xl font-semibold text-[#111827]">No products found</h3>
            <p class="text-[#6b7280] text-sm sm:text-base">Be the first to add a product to KitKeeper.</p>
          {% endif %}
          <a href="#" onclick="openCreateModal();return false;"
             class="mt-3 inline-block px-4 py-2 bg-white text-primary border border-primary rounded-xl
                    hover:bg-[#ffb6c1] hover:text-white hover:border-[#ffb6c1] transition-colors">
            + Add Product
          </a>
        </div>
      {% endif %}
    </div>

    <!-- AJAX STATES -->
    <div id="loading" class="bg-white rounded-lg border p-12 text-center hidden">
      <div class="animate-spin mx-auto h-8 w-8 border-4 border-gray-300 border-t-[#AF6E4E] rounded-full"></div>
      <p class="text-gray-600 mt-3">Loading products...</p>
    </div>

    <div id="error" class="hidden"></div>
    <div id="grid" class="hidden"></div>

    <div id="empty" class="bg-white rounded-lg border p-12 text-center hidden">
      <div class="w-32 h-32 mx-auto mb-4">
        <img src="{% static 'img/empty-products.png' %}" alt="No products" class="w-full h-full object-contain">
      </div>
      <h3 class="text-lg font-medium text-gray-900 mb-2">No products found</h3>
      <p class="text-gray-500 mb-6">Be the first to add a product to KitKeeper.</p>
      <a href="#" onclick="openCreateModal();return false;"
         class="inline-flex items-center px-4 py-2 bg-white text-primary border border-primary rounded-xl
                hover:bg-[#ffb6c1] hover:text-white hover:border-[#ffb6c1] transition-colors">
        + Add Product
      </a>
    </div>

  </div>
</div>

<!-- CONFIRM DELETE (custom) -->
<div id="confirmDeleteModal" class="hidden fixed inset-0 z-[1000] bg-black/40 backdrop-blur-[1px] flex items-center justify-center">
  <div class="bg-white rounded-[16px] border border-black/10 shadow-xl w-[92%] sm:w-[420px]">
    <div class="px-5 py-4 border-b bg-[radial-gradient(circle,_#EED9DC,_#D2A3A9,_#C28F95)] rounded-t-[16px]">
      <h4 class="m-0 text-white font-bold">Delete Product</h4>
    </div>
    <div class="px-5 py-4 text-[#111827]">Are you sure you want to delete this product?</div>
    <div class="px-5 py-4 border-t flex gap-2 justify-end bg-[#fafafa] rounded-b-[16px]">
      <button type="button" class="px-4 py-2 rounded-xl border border-black/15 hover:bg-gray-100" onclick="hideConfirmDelete()">Cancel</button>
      <button type="button" id="confirmDeleteBtn" class="px-4 py-2 rounded-xl bg-[#ECAD8F] text-white hover:opacity-90">Delete</button>
    </div>
  </div>
</div>

<!-- SCRIPTS -->
<script>
/* ===== Config ===== */
const PRODUCTS_API_ENDPOINT = "{% url 'main:show_json' %}";
const DETAIL_URL_TEMPLATE   = "{% url 'main:show_product' '00000000-0000-0000-0000-000000000000' %}";
const DELETE_ENDPOINT_TPL   = "{% url 'main:delete_product_entry_ajax' '00000000-0000-0000-0000-000000000000' %}";
const CURRENT_USER_ID       = "{{ user.id|default_if_none:'' }}";

/* ===== DOM ===== */
const loadingSpinner      = document.getElementById('loading');
const errorMessage        = document.getElementById('error');
const emptyStateDisplay   = document.getElementById('empty');
const productsGrid        = document.getElementById('grid');
const showAllButton       = document.getElementById('filter-all');
const showMyButton        = document.getElementById('filter-my');
const serverRenderedBlock = document.getElementById('kk-server-list');
const refreshBtn          = document.getElementById('btn-refresh');
const rfIcon              = document.getElementById('rf-icon');

/* ===== State ===== */
let activeFilter = 'all';
let allProductsData = [];
let pendingDeleteId = null;

/* ===== Utils ===== */
function safe(s){ return (typeof DOMPurify!=='undefined') ? DOMPurify.sanitize(String(s ?? '')) : String(s ?? ''); }
function makeDetailUrl(id){ return DETAIL_URL_TEMPLATE.replace('00000000-0000-0000-0000-000000000000', String(id)); }

function updateFilterButtonsAppearance() {
  if (!showAllButton || !showMyButton) return;
  if (activeFilter === 'all') {
    showAllButton.className = "px-3 py-2 rounded-[12px] border text-sm sm:text-[0.95rem] bg-[#fff7cc] border-[#f5df95] text-[#111827] font-semibold";
    showMyButton.className  = "px-3 py-2 rounded-[12px] border text-sm sm:text-[0.95rem] bg-white border-[#e5e7eb] text-[#111827] hover:bg-[#ffb6c1] hover:text-white hover:border-[#ffb6c1]";
  } else {
    showMyButton.className  = "px-3 py-2 rounded-[12px] border text-sm sm:text-[0.95rem] bg-[#fff7cc] border-[#f5df95] text-[#111827] font-semibold";
    showAllButton.className = "px-3 py-2 rounded-[12px] border text-sm sm:text-[0.95rem] bg-white border-[#e5e7eb] text-[#111827] hover:bg-[#ffb6c1] hover:text-white hover:border-[#ffb6c1]";
  }
}

function displayPageSection({ showLoading=false, showError=false, showEmpty=false, showGrid=false }) {
  loadingSpinner.classList.toggle('hidden', !showLoading);
  errorMessage.classList.toggle('hidden', !showError);
  emptyStateDisplay.classList.toggle('hidden', !showEmpty);
  productsGrid.classList.toggle('hidden', !showGrid);
  if (showGrid) {
    serverRenderedBlock?.classList.add('hidden');
    productsGrid.className = 'grid gap-5 sm:grid-cols-2 lg:grid-cols-3 justify-items-center';
  }
}

/* ===== Refresh UX ===== */
function setRefreshing(on){
  if (!refreshBtn) return;
  refreshBtn.disabled = on;
  refreshBtn.classList.toggle('opacity-60', on);
  refreshBtn.classList.toggle('cursor-not-allowed', on);
  rfIcon?.classList.toggle('hidden', !on);
  rfIcon?.classList.toggle('animate-spin', on);
}
refreshBtn?.addEventListener('click', () => {
  setRefreshing(true);
  displayPageSection({ showLoading:true });
  fetchProductsFromServer().finally(()=> setRefreshing(false));
});

/* ===== Confirm Delete ===== */
function showConfirmDelete(productId){
  pendingDeleteId = productId;
  document.getElementById('confirmDeleteModal').classList.remove('hidden');
}
function hideConfirmDelete(){
  pendingDeleteId = null;
  document.getElementById('confirmDeleteModal').classList.add('hidden');
}
async function doConfirmDelete(){
  if (!pendingDeleteId) return;
  const url = DELETE_ENDPOINT_TPL.replace('00000000-0000-0000-0000-000000000000', pendingDeleteId);
  try{
    const res = await fetch(url, { method:'POST' });
    const data = await res.json().catch(()=> ({}));
    if (!res.ok){ (window.showToast?showToast('Failed','Delete failed'):alert('Delete failed')); return; }
    window.showToast && showToast('Success','Product deleted');
    document.dispatchEvent(new CustomEvent('productDeleted', { detail:{ id: pendingDeleteId } }));
  } finally {
    hideConfirmDelete();
  }
}
document.getElementById('confirmDeleteBtn').addEventListener('click', doConfirmDelete);

/* ===== Card Builder ===== */
function buildProductCardElement(product, index) {
  const name  = safe(product.name);
  const team  = product.team ? ` — ${safe(product.team)}` : '';
  const img   = product.thumbnail ? `<img src="${safe(product.thumbnail)}" alt="${name}" class="w-full h-full object-cover block">`
                                  : `<div class="w-full h-full flex items-center justify-center text-[#888]">No Image</div>`;
  const isOwner = String(product.user_id||'') === String(CURRENT_USER_ID||'');
  const pill = "inline-flex items-center justify-center px-3 py-1.5 rounded-xl text-[0.85rem] bg-white text-primary border border-primary transition-colors hover:bg-[#ECAD8F] hover:text-white hover:border-[#ECAD8F]";
  const ownerActions = isOwner ? `
    <div class="flex items-center gap-2 shrink-0">
      <button type="button" class="${pill}" onclick="openUpdateModal('${product.id}')">Edit</button>
      <button type="button" class="${pill}" onclick="showConfirmDelete('${product.id}')">Delete</button>
    </div>` : "";

  const el = document.createElement('div');
  el.innerHTML = `
<div>
  <div class="rounded-[18px] p-3 sm:p-4 bg-[#E6DCE5] border border-black/10 shadow-[0_8px_20px_rgba(0,0,0,.12)]
              w-full md:w-[300px] md:h-[500px] md:flex md:flex-col md:gap-2
              transition-all duration-300 hover:shadow-[0_12px_24px_rgba(0,0,0,.18)] hover:-translate-y-1">

    <div class="grid gap-2 sm:gap-3 grid-cols-1 sm:grid-cols-[160px_1fr] items-stretch md:grid-cols-1 md:contents">
      <div class="border-[1.5px] border-black/20 rounded-xl overflow-hidden bg-[#f6f6f6]
                  aspect-[4/3] sm:aspect-auto sm:h-[130px] md:h-[66%] md:aspect-auto">
        ${img}
      </div>

      <div class="border-[1.5px] border-black/20 rounded-xl p-2.5 sm:p-3 grid gap-2
                  md:h-[34%] md:grid-rows-[auto_1px_auto_1fr_auto]">

        <div class="flex items-center justify-between gap-2">
          <span class="inline-block text-[0.68rem] tracking-[0.06em] uppercase bg-white border border-black/10 py-[0.16rem] px-2 rounded-full">
            Product ${index+1}
          </span>
          ${ownerActions}
        </div>

        <div class="flex items-center justify-between gap-3">
          <h3 class="m-0 text-[1rem] sm:text-[1.1rem] md:text-[1rem] leading-tight font-semibold truncate">
            ${name}
          </h3>
        </div>

        <div class="w-full h-px bg-black/20"></div>

        <div class="space-y-1">
          <p class="m-0 text-[#222] text-[0.9rem]">Jersey${team}</p>
          <div class="mt-1 flex items-center justify-between">
            <p class="m-0 font-bold" style="color:#AF6E4E">
              Rp <span class="kk-idr" data-idr="${product.price||0}">${product.price||0}</span>
            </p>
            <a href="${makeDetailUrl(product.id)}" class="${pill}">Detail</a>
          </div>
        </div>

      </div>
    </div>
  </div>
</div>`;
  return el.firstElementChild;
}

/* ===== Render / Filter / Fetch ===== */
function renderAllProductCards(items){
  productsGrid.innerHTML = '';
  items.forEach((item, idx) => productsGrid.appendChild(buildProductCardElement(item, idx)));
  const fmt = new Intl.NumberFormat('id-ID');
  productsGrid.querySelectorAll('.kk-idr').forEach(el=>{
    const v = parseInt(el.getAttribute('data-idr'),10);
    if(!isNaN(v)) el.textContent = fmt.format(v);
  });
}
function filterAndDisplayProducts(){
  updateFilterButtonsAppearance();
  let filtered = allProductsData;
  if (activeFilter === 'my' && CURRENT_USER_ID) {
    filtered = allProductsData.filter(p => String(p.user_id) === String(CURRENT_USER_ID));
  }
  if (!filtered.length) displayPageSection({ showEmpty:true });
  else { renderAllProductCards(filtered); displayPageSection({ showGrid:true }); }
}
async function fetchProductsFromServer(){
  try{
    const res = await fetch(PRODUCTS_API_ENDPOINT, { headers:{'Accept':'application/json'} });
    if(!res.ok) throw new Error('Failed to fetch products');
    allProductsData = await res.json() || [];
    filterAndDisplayProducts();
  }catch(err){
    console.error(err);
    errorMessage.className = "rounded-xl border border-red-300 bg-red-50 p-4 text-red-800";
    errorMessage.innerHTML = "Gagal memuat data. <button class='underline' onclick='fetchProductsFromServer()'>Coba lagi</button>";
    displayPageSection({ showError:true });
  }
}

/* ===== Init & Events ===== */
function handleShowAllClick(e){ e.preventDefault(); activeFilter='all'; filterAndDisplayProducts(); }
function handleShowMyClick(e){ e.preventDefault(); activeFilter='my';  filterAndDisplayProducts(); }
function initializeProductsPage(){
  showAllButton?.addEventListener('click', handleShowAllClick);
  showMyButton?.addEventListener('click', handleShowMyClick);
  displayPageSection({ showLoading:true });
  fetchProductsFromServer();
}
initializeProductsPage();

document.addEventListener('productAdded',   fetchProductsFromServer);
document.addEventListener('productUpdated', fetchProductsFromServer);
document.addEventListener('productDeleted', fetchProductsFromServer);

/* ===== Price formatter for initial server list ===== */
(function () {
  if (window.__kkFormatPrice) return; window.__kkFormatPrice = true;
  var fmt = new Intl.NumberFormat('id-ID');
  document.querySelectorAll('.kk-idr').forEach(function(el){
    var v = parseInt(el.getAttribute('data-idr'), 10);
    if (!isNaN(v)) el.textContent = fmt.format(v);
  });
})();
</script>
{% endblock content %}
