{% extends "base.html" %}
{% block title %}Register â€” KitKeeper{% endblock %}

{% block content %}
<div class="fixed inset-0 -z-10 bg-kk-pink"></div>
<div class="min-h-[calc(100dvh-4rem)] grid place-items-center px-3 sm:px-4">
  <div class="w-full max-w-[480px] rounded-[20px] p-5 sm:p-6 md:p-8
              bg-kk-rose border border-black/10 shadow-[0_14px_32px_rgba(0,0,0,0.14)]">
    <div class="mb-3">
      <h1 class="m-0 text-2xl sm:text-[1.35rem] tracking-[0.2px] font-bold text-textBaseWhite">Create your account</h1>
      <p class="mt-0.5 mb-0 text-textGray text-[0.92rem]">It takes less than a minute</p>
    </div>

    <form id="register-form" method="POST" novalidate>
      {% csrf_token %}

      {% if form.non_field_errors %}
        <div class="mt-1 text-error text-[0.9rem]">{{ form.non_field_errors }}</div>
      {% endif %}

      <!-- Username -->
      <div class="my-3">
        <label for="{{ form.username.id_for_label }}" class="block text-[0.85rem] text-textDark mb-1.5">Username</label>
        <input type="text" name="username" id="{{ form.username.id_for_label }}"
               class="block w-full rounded-xl border border-black/20 bg-white py-3 px-3.5 text-[0.96rem]
                      outline-none focus:ring-2 focus:ring-[#6366F1] focus:border-transparent"
               autocapitalize="none" spellcheck="false">
        <div class="kk-field-error text-[0.85rem] text-red-700 mt-1 hidden" data-for="username"></div>
        {% if form.username.help_text %}
          <div class="mt-1.5 text-[#6b7280] text-[0.85rem] leading-snug">{{ form.username.help_text|safe }}</div>
        {% endif %}
      </div>

      <!-- Password -->
      <div class="my-3">
        <label for="{{ form.password1.id_for_label }}" class="block text-[0.85rem] text-textDark mb-1.5">Password</label>
        <input type="password" name="password1" id="{{ form.password1.id_for_label }}"
               class="block w-full rounded-xl border border-black/20 bg-white py-3 px-3.5 text-[0.96rem]
                      outline-none focus:ring-2 focus:ring-[#6366F1] focus:border-transparent">
        <div class="kk-field-error text-[0.85rem] text-red-700 mt-1 hidden" data-for="password1"></div>
        {% if form.password1.help_text %}
          <div class="mt-1.5 text-[#6b7280] text-[0.85rem] leading-snug">{{ form.password1.help_text|safe }}</div>
        {% endif %}
      </div>

      <!-- Confirm Password -->
      <div class="my-3">
        <label for="{{ form.password2.id_for_label }}" class="block text-[0.85rem] text-textDark mb-1.5">Confirm Password</label>
        <input type="password" name="password2" id="{{ form.password2.id_for_label }}"
               class="block w-full rounded-xl border border-black/20 bg-white py-3 px-3.5 text-[0.96rem]
                      outline-none focus:ring-2 focus:ring-[#6366F1] focus:border-transparent">
        <div class="kk-field-error text-[0.85rem] text-red-700 mt-1 hidden" data-for="password2"></div>
      </div>

      <button type="submit"
        class="w-full mt-3.5 py-3 px-4 font-semibold tracking-[0.2px] bg-white text-[#111827] rounded-[14px]
               border border-[#111827] hover:bg-[#ffb6c1] hover:text-white hover:border-[#ffb6c1] transition">
        Sign Up
      </button>

      <div id="register-error" class="hidden rounded-xl border border-red-300 bg-red-50 p-3 text-red-800 mt-3"></div>
    </form>

    <p class="mt-3 text-[0.92rem] text-textGray">
      Already have an account?
      <a class="text-linkText no-underline hover:underline font-bold" href="{% url 'main:login' %}">Sign In</a>
    </p>
  </div>
</div>

<script>
  (function(){
    const form = document.getElementById('register-form');
    const btn  = form.querySelector('button[type="submit"]');
    const err  = document.getElementById('register-error');
  
    function setFieldError(name, msgs){
      const box = form.querySelector(`.kk-field-error[data-for="${name}"]`);
      if (!box) return;
      if (msgs && msgs.length) {
        box.innerHTML = msgs.join("<br>");
        box.classList.remove('hidden');
      } else {
        box.textContent = "";
        box.classList.add('hidden');
      }
    }
    function clearFieldErrors(){
      form.querySelectorAll('.kk-field-error').forEach(b=>{ b.textContent=""; b.classList.add('hidden'); });
    }
  
    form.addEventListener('submit', async (e)=>{
      e.preventDefault();
      btn.disabled = true;
      err.classList.add('hidden');
      clearFieldErrors();
  
      try {
        const fd = new FormData(form);
        const res = await fetch("{% url 'main:register_ajax' %}", {
          method: "POST",
          body: fd,
          credentials: "same-origin",
          headers: { "X-Requested-With": "XMLHttpRequest" },
        });
        const data = await res.json().catch(()=> ({}));
  
        if (!res.ok) {
          if (data?.errors) {
            for (const [name, msgs] of Object.entries(data.errors)) setFieldError(name, msgs);
            err.textContent = "Please check your input.";
          } else {
            err.textContent = data?.detail || "Registration failed.";
          }
          err.classList.remove('hidden');
          // Optional: toast error on failure
          if (typeof showToast === 'function') showToast("Error", "Registration failed.");
          return;
        }
  
        // === Sukses: simpan toast ke sessionStorage (dibaca di base.html) ===
        try {
          sessionStorage.setItem('kk_toast', JSON.stringify({
            title: 'Success',
            message: 'Registration successful. Please sign in.',
          }));
        } catch (_) {}
  
        // Redirect ke halaman login (sesuai response server)
        redirectWithToast("Success", "Registration successful. Please sign in.", data.redirect || "{% url 'main:login' %}");
      } catch (ex) {
        err.textContent = "Connection error.";
        err.classList.remove('hidden');
        if (typeof showToast === 'function') showToast("Error", "Network error when registering.");
      } finally {
        btn.disabled = false;
      }
    });
  })();
  </script>
  
{% endblock %}
